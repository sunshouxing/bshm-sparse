name: ${topology.name}

config:
  pystorm.log.backup_count: 10
  pystorm.log.file: pystorm_{topology_name}_{component_name}_{task_id}_{pid}.log
  pystorm.log.level: debug
  pystorm.log.max_bytes: 100000
  pystorm.log.path: /logs
  storm.workers.list: []
  topology.workers: 1
  topology.message.timeout.secs: 60
  topology.max.spout.pending: 30

components:
  - id: bshmScheme
    className: bshm.spouts.scheme.BshmScheme

  - id: stringMultiScheme
    className: org.apache.storm.spout.SchemeAsMultiScheme
    constructorArgs:
      - ref: bshmScheme

  - id: zkHosts
    className: org.apache.storm.kafka.ZkHosts
    constructorArgs:
      - zookeeper:2888

  - id: spoutConfig
    className: org.apache.storm.kafka.SpoutConfig
    constructorArgs:
      # brokerHosts
      - ref: zkHosts
      # topic
      - ${kafka.topic}
      # zkRoot
      - /kafkaSpout
      # id
      - myId
    properties:
      - name: ignoreZkOffsets
        value: true
      - name: scheme
        ref: stringMultiScheme

  - id: mongoMapper
    className: bshm.bolts.mongodb.common.mapper.SimpleMongoMapper
    configMethods:
      - name: withFields
        args:
          - - timestamp
            - time_increment
            - channel_name
            - data

# spout definitions
spouts:
  - id: bshmSpout
    className: org.apache.storm.kafka.KafkaSpout
    constructorArgs:
      - ref: spoutConfig
    parallelism: 1

# bolt definitions
bolts:

  - id: mongoBolt
    className: org.apache.storm.mongodb.bolt.MongoInsertBolt
    constructorArgs:
      - ${mongodb.url}
      - ${mongodb.collection}
      - ref: mongoMapper
    parallelism: 2

  - id: logInfoBolt
    className: org.apache.storm.flux.wrappers.bolts.FluxShellBolt
    constructorArgs:
      - - streamparse_run
        - -s json bolts.log_info.LogInfoBolt
    parallelism: 1

  - id: tdmsParseBolt
    className: org.apache.storm.flux.wrappers.bolts.FluxShellBolt
    configMethods:
      - name: setNamedStream
        args:
          - ALL-CHANNELS
          - ${channel.tuple.fields}
    constructorArgs:
      - - streamparse_run
        - -s json bolts.tdms_parse.TDMSParseBolt
    parallelism: 4

# streams defination
includes:
  - resource: false
    file: 'streams-baofu-simple.yaml'
    override: false

# vim:set sw=2 ts=2 sts=2: #
